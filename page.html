<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Configure Flow</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/1.4.1/jquery.jsPlumb-1.4.1-all-min.js"></script>

    <link rel="stylesheet" href="style.css" />
</head>
	
<body>


<div id="app" class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-2">
            <h1 class="ui-widget-header">Components</h1>
            <v-catalog></v-catalog>
        </div>
        <div id="flow-panel" class="col">
            <div class="row" style="height: 90%;">
                <div class="col">
                    <h1 class="ui-widget-header">Price Flow</h1>
                    <div class="ui-widget-content" style="height: 100%;">
                        <v-flow>                            
                        </v-flow>                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
<script src="script.js"></script>
<script>
    Vue.component('v-catalog',
    {
        data: () => {
            return {
                currentMenu: 0,
            };
        },

        methods: {
            nextMenu: () => {

            },
        },
        mounted: () => {
            $("#catalog").accordion({
                heightStyle: "content",
            });
        },
        template:
            `
            <div id="catalog">
                <h2><a href="#">Offers</a></h2>
                <div>
                    <ul>
                        <li class='offer'>Office 365</li>
                        <li class='offer'>Windows</li>
                        <li class='offer'>Sql Server</li>
                    </ul>
                </div>
                <h2><a href="#">Modifiers</a></h2>
                <div>
                    <ul>
                        <li>Discont %</li>
                        <li>Discont $</li>
                        <li class='if'>Quantity</li>
                    </ul>
                </div>
            </div>
            `
    });

    let wasInitialized = false;

    Vue.component('v-flow',
    {
        mounted: () => {

            $( "#catalog li" ).draggable({
                appendTo: "body",
                helper: "clone"
            });
            $("#flow").droppable({
                activeClass: "highlight",
                hoverClass: "highlight-accept",
                accept: "ul li",
                drop: function (event, ui) {

                    let $drowingWindow = $("#flow");

                    if (!wasInitialized){

                        $(this).find(".placeholder").remove();
                    
                        var $accordion = $("#catalog");
                        var current = $accordion.accordion("option","active"),
                            maximum = $accordion.find("h3").length,
                            next = current+1 === maximum ? 0 : current+1;
                        //$accordion.accordion("activate",next);
                        $accordion.accordion("option","active",next);                    


                        //drowing logic
                        let startElement = $(`<div class="startpoint point node" style="left: 650px; top:100px" data-nodetype="startpoint" id="startpoint">
                                                <h5>${ui.draggable.text()}</h5>
                                                <h5>Vendor's price 175$</h5>
                                            </div>`);
                        startElement.appendTo($drowingWindow);

                        let endElement = $(`<div class="endpoint point window node" style="left: 650px; top:850px" data-nodetype="endpoint" id="endpoint">
                                                Finish Selling Flow
                                            </div>`);
                        endElement.appendTo($drowingWindow);


                        jsPlumb.draggable($(".window"));

                        jsPlumb.importDefaults({
                            Endpoint : ["Dot", {radius:8}],
                            EndpointStyle : { fillStyle : "#4A6" },
                            HoverPaintStyle : {strokeStyle:"#42a62c", lineWidth:8 },
                            Connector:[ "Flowchart" ],
                            ConnectionOverlays : [
                                [ "Arrow", { 
                                    location:1,
                                    id:"arrow",
                                    length:20,
                                    foldback:0.4
                                } ]
                            ]
                        });            

                        var workflowConnectorStartpoint = {
                            isSource: true,
                            isTarget: false,
                            maxConnections: 1,				 
                            anchor:"BottomCenter"
                        };           

                        jsPlumb.addEndpoint(
                            $('.startpoint'),
                            workflowConnectorStartpoint
                        ); 

                        var workflowConnectorEndpoint = {
                            isSource: false,
                            isTarget: true,
                            maxConnections: -1,				 
                            anchor:"TopCenter",
                            paintStyle: { fillStyle: 'red' },
                            endpoint: ["Rectangle", {width:12, height:12}]
                        };

                        jsPlumb.addEndpoint(
                            $('.endpoint'),
                            workflowConnectorEndpoint
                        );

                        $drowingWindow.on("click", ".button_remove", function () {
                            var parentnode = $(this)[0].parentNode.parentNode;
                            jsPlumb.detachAllConnections(parentnode);
                            jsPlumb.removeAllEndpoints(parentnode);
                            $(parentnode).remove(); 
                        });
	

                        wasInitialized = true;
                    } else {

                        console.log(ui.draggable);

                        if (ui.draggable[0].classList.value.indexOf('if') >= 0) {
                            console.log("add decision");
                            addDecistion(ui.draggable, $drowingWindow);
                        }else{
                            console.log("add task");
                            addTask(ui.draggable, $drowingWindow);    
                        }
                        numberOfElements++;
                    }

                }
            });

            

        },
        template: 
        `
        <div id="flow" class="jtk-demo-canvas canvas-wide chart-demo jtk-surface jtk-surface-nopan">
            <div class="placeholder">Drop Offer here</div>
        </div>
        `
    });

    new Vue({
        el: '#app',
        data: {
            
        },
        methods: {
        },        
        mounted: function() {

            


            	

        },
    });

    function addTask(draggable, $drowingWindow){        

        var id = "task-"+numberOfElements;
        let element = $(`<div class="task node" style="left: 220px; top: 350px;" data-nodetype="task" id="${id}">
                                                <div class="details_container">
                                                    <label class="detail_label">${draggable.text()}</label>
                                                    <input value="" class="detail_text"/>
                                                    <br/>
                                                    <h6 class="price"></h6>
                                                </div>
                                                <div class="ctrl_container">
                                                    <div class="button_remove">x</div>
                                                </div>
                                            </div>`);
        element.appendTo($drowingWindow);        

        var taskSourceConnectorEndpoint = {
            isSource: true,
            isTarget: false,
            maxConnections: 1,
            anchor:[ 0.5, 1, 0, 1, 0, 0 , "task_end endpoint"],
        };

        var taskTargetConnectorEndpoint = {
            isSource: false,
            isTarget: true,
            maxConnections: 1,	
            anchor:[ 0.5, 0, 0, -1, 0, 0 , "task_end endpoint"],
            paintStyle: { fillStyle: 'red' },
            endpoint: ["Rectangle", {width:12, height:12}]
        };
        
        jsPlumb.addEndpoint(
            element,
            taskSourceConnectorEndpoint
        );
        
        jsPlumb.addEndpoint(
            element,
            taskTargetConnectorEndpoint
        );
        
        jsPlumb.draggable(element);
    }

    function addDecistion(draggable, $drowingWindow){
        var id = "decision-"+numberOfElements;
        let element = $(`<div class="decision" style="left: 250px; top:400px;" data-nodetype="decision" id="${id}">
                            <div class="details_container">
                                <label class="detail_label">Quantity &lt;</label>
                                <input value="" class="detail_text"/>
                            </div>
                            <div class="ctrl_container">
                                <div class="button_remove">x</div>
                            </div>
                        </div>`);
        element.appendTo($drowingWindow);        

        var upperDecisionConnectorEndpoint = {
            isSource: false,
            isTarget: true,
            maxConnections: 1,				 
            anchor:[ 0.5, 0, 0, -1, 16, 0 , "upper_dec_end endpoint"],
            paintStyle: { fillStyle: 'red' },
            endpoint: ["Rectangle", {width:12, height:12}]
        };
        
        var leftDecisionConnectorEndpoint = {
            isSource: true,
            isTarget: false,
            maxConnections: 1,				 
            anchor:[ 0, 0.5, 0, 1, 0, 16 , "left_dec_start startpoint"]
        };
        
        var rightDecisionConnectorEndpoint = {
            isSource: true,
            isTarget: false,
            maxConnections: 1,				 
            anchor:[ 1.0, 0.5, 0, 1, 32, 16 , "right_dec_start startpoint"]
        };
        
        jsPlumb.addEndpoint(
            $('#'+id),
            leftDecisionConnectorEndpoint
        );
        
        jsPlumb.addEndpoint(
            $('#'+id),
            rightDecisionConnectorEndpoint
        );
        
        jsPlumb.addEndpoint(
            $('#'+id),
            upperDecisionConnectorEndpoint
        );
        
        jsPlumb.draggable($('#' + id));
    }

    let numberOfElements = 0;

    $(document).ready(function(){

        $("body").on("keyup", "input", function(){

            let input = $(this);
            setTimeout(function(){

                
                let isPercent = input.parent().find("label").text().indexOf("%") >= 0;
                console.log("is percent", isPercent);
                let price = 175;
                if (isPercent){
                    price = price - price*(+input.val())/100;
                    price = price.toFixed(2);
                }else{
                    price = price - (+input.val());
                }

            
                input.parent().find(".price").delay(3000).text("Reseller's price: "+price+"$");
                input.parent().parent().find(".ctrl_container").css("top", "-111px");
            }, 1500);

            

        });

    });

</script>

</body>
</html>